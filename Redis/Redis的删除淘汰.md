# Redis的删除与淘汰策略  
## 删除与淘汰的区别   
删除策略：删除的是已过期的数据  
淘汰策略：淘汰的是未过期的数据  
## 删除策略  
1、过期数据指的是TTL指令返回 -2 的数据  
2、时效性数据的存储结构：数据的时效信息是一块独立的存储空间，Hash结构，field是数据的内存地址，value是过期时间，当时间到期后通过field找到该数据在内存中的地址，进行相关的操作  
3、数据的删除策略有三种：定时、定期、惰性删除  
### 定时删除  
1、创建一个定时器，当key的过期时间到达时，立即执行对key的删除操作  
2、优点：节约内存，到时就删除，快速释放不必要的内存占用  
3、缺点：CPU压力大，会影响Redis服务器响应时间（无论CPU是否繁忙，到时间就要执行删除操作）  
4、总结：处理器性能换存储空间 (时间换空间)  
### 惰性删除  
1、即使数据到达过期时间，也不做处理（一直存在），下次访问(get)该数据时，进行判断：如果未过期，返回数据；如果已过期，删除，返回不存在。  
2、优点：节约CPU性能，并不会立即删除  
3、缺点：内存压力大，出现长期占用内存的数据 （到期之后长时间不执行get操作）
4、总结：用存储空间换取处理器性能 (空间换时间)  
注意：执行get指令时，Redis会隐性的先执行expireIfNeeded()，判断数据是否已经过期  
### 定期删除  
1、定期删除就是周期轮询Redis库中的时效性数据，采用随机抽取的策略，利用过期数据占比的方式控制删除频度。  
2、内存压力不是很大，CPU压力不是很大。  
3、检测频度可自定义设置。  

定期删除流程 
![result](https://static01.imgkr.com/temp/febc0c60732447e38bb599d1e7042bd0.png)    

注意:根据默认值server.hz，activeExpireCycle()一秒钟检测10次，每次检测耗时25ms，即一秒钟执行检测的时间为250ms (占用cpu1/4时间),如果 activeExpireCycle() 执行时间到期 (只可占用CPU的1/4时间)，下次从 (current_db + 1) % 16 继续向后执行。      
## 淘汰策略  
场景：新数据进入Redis时，如果内存不够，需要淘汰一些数据。  
注意：Redis在执行每个指令前，会调用 freeMemoryIfNeeded() 检测内存是否充足且释放内存。  
### 数据淘汰的相关配置  
1、分配给Redis的最大内存，通常设置为占用物理内存的50%以上(maxmemory ?mb)  
2、每次随机选择的待删除数据的个数(maxmemory -samples count)  
3、对数据进行淘汰的策略(maxmemory-policy policy)  

### 淘汰策略类别  
淘汰策略分为三大类：检测易失数据、检测全库数据、放弃驱逐数据  
1、检测易失(过期)数据(server.db[i].expires)    
![result](https://static01.imgkr.com/temp/d072c94ad99c44f39b35309cb35e7ec0.png)  
2、检测全库数据(检测所有数据集 server.db[i].dict)  
![result](https://static01.imgkr.com/temp/e35a90971d4a4cc5aac54265582c2193.png)  
3、放弃数据驱逐(不淘汰数据)  
no-enviction(禁止驱逐数据)

  


